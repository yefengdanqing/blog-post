---
title: redis--主从复制
toc: true
date: 2022-02-22 23:44:59
tags:
- redis
categories:
- 组件
typora-root-url: ..\img
---

###### **旧版复制**

- 方式：salveof    ip   port
- 实现：同步和命令传播
- 同步：
  - 同步是从服务器像主服务器发送sync命令开始
  - 主服务器接收到从服务器的的sync命令后，开始由子进程（bgsave)生成一个rdb文件，同时使用一个缓冲区记录现在开始写入的命令

- rdb写入完成后，由子进程发送rdb文件给从服务器,从服务器通过rdb更新这个从服务器的库至bgsave。
- 主服务器发送缓冲区里的的命令给从服务器，从服务器执行这些命令，达到和从服务器一样的状态
- 命令传播：主服务器会将所有的写命令发送给从服务器来达到主从一直的情况
- 缺陷：断线重连不能高效的完成，从服务器需要重新加载rdb文件

<!-- more -->

###### **新版复制**

- 方式：salveof  ip   port
- 实现：同步和命令传播
- 同步：完全重同步和部分重同步
   - 同步通过psync命令开始
   - 完整重同步用于第一次同步，和旧版的同步一样。
   - 部分重同步用于解决断线重连重新复制的低效问题。
   - 从服务器发现自己掉线，发送psync
      - 接受continue，准备接受部分重同步
      - 开始

   - 命令传播
   - 命令传播

- 缺陷：

###### **部分重同步**

- 构成部分：复制偏移量、复制挤压缓冲区和服务器的运行id
- 同步过程：主从服务器都各自维护一个复制偏移量，主有个固定长度的复制挤压缓冲区队列
- 正常主服务器向从服务器发送N个字节时，主和从都会在偏移量上加N
   - 当断线后，从向主发送psync命令，并将自己的偏移量和服务运行id告诉主服务器，如果从服务器发送的运行id和当前的id一样，再根据偏移量来判断，主服务器发现这个偏移量在自己的缓冲区里面，就执行部分冲同步；不在就执行完全重同步；如果运行id不一样就执行完全重同步。
   - PSYNC命令的调用方法：从服务器在开始一次新的复制时将向主服务器发送PSYNC ? -1命令，主动请求主服务器 进行完整重同步（因为这时不可能执行部分重同步）。·相反地，如果从服务器已经复制过某个主服务器，那么从服务器在开始一次新的复制时 将向主服务器发送PSYNC <runid> <offset>命令：其


###### **心跳检测机制**

检查连接是否正常

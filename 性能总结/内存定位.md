---
title: 内存泄漏定位
toc: true
date: 2022-06-14 22:26:59
tags:
- 
categories:
- 
typora-root-url: ..\img
---

### asan和lsan简介

### asan使用

<!-- more -->

---

#### AddressSanitizerFlags

##### compiler flags

| flag                       | description                                                  |
| -------------------------- | ------------------------------------------------------------ |
| -fsanitize=address         | Enable [AddressSanitizer](https://github.com/google/sanitizers/wiki/AddressSanitizer) |
| -fno-omit-frame-pointer    | Leave frame pointers. Allows the fast unwinder to function properly. |
| -fsanitize-blacklist=path  | Pass a [blacklist file](https://github.com/google/sanitizers/wiki/AddressSanitizer#turning-off-instrumentation) |
| -fno-common                | Do not treat global variable in C as common variables (allows ASan to instrument them |
| -fsanitize-recover=address | 一般后台程序为保证稳定性，不能遇到错误就简单退出，而是继续运行，采用该选项支持内存出错之后程序继续运行，需要叠加设置*ASAN_OPTIONS=halt_on_error=0*才会生效；若未设置此选项，则内存出错即报错退出 |
|                            |                                                              |
|                            |                                                              |



``` makefile
SET( CMAKE_CXX_FLAGS_ASAN "-O1 -g -fsanitize=address -fsanitize-recover=address -fno-omit-frame-pointer" CACHE STRING
    "Flags used by the C++ compiler during asan builds."
    FORCE )
SET( CMAKE_C_FLAGS_ASAN "-O1 -g -fsanitize=address -fsanitize-recover=address -fno-omit-frame-pointer" CACHE STRING
    "Flags used by the C compiler during asan builds."
    FORCE )
SET( CMAKE_EXE_LINKER_FLAGS_ASAN
    "-static-libasan" CACHE STRING
    "Flags used for linking binaries during asan builds."
    FORCE )
SET( CMAKE_SHARED_LINKER_FLAGS_ASAN
    "-static-libasan" CACHE STRING
    "Flags used for linking shared libraries during asan builds."
    FORCE )
SET(CMAKE_CXX_FLAGS "-w -g -pthread -fno-omit-frame-pointer -fsanitize=address -fsanitize-recover=address -fno-stack-protector")
SET(CMAKE_CXX_FLAGS_DEBUG ${CMAKE_CXX_FLAGS})
SET(CMAKE_CXX_FLAGS_RELEASE "-w -g -pthread -O2 -fno-omit-frame-pointer -fsanitize=address -fsanitize-recover=address -fno-stack-protector")
```

##### run time flags

Most run-time flags are passed to [AddressSanitizer](https://github.com/google/sanitizers/wiki/AddressSanitizer) via `ASAN_OPTIONS` environment variable like this:[加了没起来]

```
ASAN_OPTIONS=verbosity=1:malloc_context_size=20 ./a.out
# halt_on_error=0：检测内存错误后继续运行

# detect_leaks=1:使能内存泄露检测

# malloc_context_size=15：内存错误发生时，显示的调用栈层数为15

# log_path=/home/xos/asan.log:内存检查问题日志存放文件路径

#export ASAN_OPTIONS=suppressions=/path/to/asan.supp
# suppressions=$SUPP_FILE:屏蔽打印某些内存错误
常见的 suppression 类型
interceptor_via_fun:<function>：抑制特定函数引发的错误。
race:<symbol>：抑制特定符号的竞争条件错误。
leak:<symbol>：抑制特定符号的内存泄漏错误。
thread:<symbol>：抑制特定符号的线程错误。
#allocator_may_return_null=1

export ASAN_OPTIONS=halt_on_error=0:use_sigaltstack=0:detect_leaks=1:malloc_context_size=20:log_path=./asan.log:suppressions=./asan.supp:allocator_may_return_null=1

# unmap_shadow_on_exit




export ASAN_SYMBOLIZER_PATH=/usr/bin/llvm-symbolizer
export ASAN_OPTIONS=symbolize=true:halt_on_error=false:abort_on_error=false:disable_coredump=false:unmap_shadow_on_exit=true:disable_core=false:sleep_before_dying=15:fast_unwind_on_fatal=1:log_path=/data/recommend/ranker_service/asan.log
#LD_PRELOAD=/usr/lib64/libasan.so.4导入这个变量会有一些问题？
```

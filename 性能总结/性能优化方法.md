---
title: 性能优化
toc: true
date: 2022-03-04 22:26:59
tags:
- 
categories:
- 
typora-root-url: ..\img
---

### 方法

****

#### cpu火焰图

目前看到cpu-clock和cycles的结果是一样的

##### 安装 perf

yum install -y perf

<!-- more -->

##### 生成 perf.data

pid=$(pgrep service)

perf record -e cpu-clock -F 99 -p $pid -g -- sleep 30

##### 展示 perf.data

perf report --show-total-period

##### 生成火焰图

git clone https://github.com/brendangregg/FlameGraph

perf script | FlameGraph/stackcollapse-perf.pl | FlameGraph/flamegraph.pl > flamegraph.svg

![flamegraph_skt_2](https://raw.githubusercontent.com/yefengdanqing/picture_bed/master/flamegraph_skt_2.svg)

#### Heap火焰图

Tcmalloc

jemalloc不能看火焰图

perf跟踪malloc/free；跟踪brk；跟踪mmap；跟踪页错误通过gperftools来查看内存profiler结构

pprof支持三种，第一种是cpu采样，第二种是堆内存，第三种是内存泄漏

cpu采样用profiler.h文件，内存是heap_profile.h,有2种方式导出profile文件

 静态dump方法：

​    直接定义一个环境变量HEAPPROFILE来指定dumpprofile文件的位置，如：/tmp/test.log,它将会在/tmp/目录下生成很多类似/tmp/test.log.0003.heap文件名的文件

​    env HEAPPROFILE="/tmp/test.log" /test/testprog

```shell
#env HEAPPROFILE=/tmp/ranker_service/ranker_service HEAPCHECK=normal HEAP_PROFILE_ALLOCATION_INTERVAL=1073741824 HEAP_PROFILE_INUSE_INTERVAL=104857600 ./bin/ranker_service $exec_param

```

HeapProfilerStart() 用来开始内存分析

HeapProfilerStop(). 用来终止内存分析

这样就只会在开始和结束之间产生dump profiler文件

``` c++
#ifdef GPROF
#include <gperftools/profiler.h>
#include "gperftools/heap-profiler.h"
#endif

#ifdef ENABLE_GPROFTOOLS
    if (signum == SIGUSR1)
    {
        if (!isStarted)
        {
            HeapProfilerStart("gprof/rs.log");
            //ProfilerStart("test.prof");
            printf("ProfilerStart success\n");
            isStarted++;
        }
        else
        {
            HeapProfilerDump();
            //ProfilerFlush();
            printf("ProfilerFlush success\n");
        }
    }
    else if (signum == SIGUSR2)
    {
        //ProfilerStop();
        HeapProfilerStop();
        printf("ProfilerStop success\n");
    }
#endif
}
// 使用
#ifdef ENABLE_GPROFTOOLS
    signal(SIGUSR1, gprofStartAndStop);
    signal(SIGUSR2, gprofStartAndStop);
#endif
```

##### 选项

-  HEAP_PROFILE_ALLOCATION_INTERVAL

程序内存每增长这一数值之后就dump 一次内存，默认是1G （1073741824）

-  HEAP_PROFILE_INUSE_INTERVAL

程序如果一次性分配内存超过这个数值dump 默认是100K

##### 使用

pprof --text ./bin文件 ./heap_file.prof



``` shell
yum install graphviz【可能有版本问题，可以自己下载rpm 包】

首先，请确保您已正确安装 gperftools 工具并按照指南设置好了分析环境。在确认设置正确后，可以尝试以下步骤：

确认您使用的命令是否正确。例如，如果您想要生成 CPU 性能分析报告，可以使用以下命令：

pprof --pdf /path/to/binary /path/to/profile > output.pdf
其中 /path/to/binary 是可执行文件的路径，/path/to/profile 是分析结果文件的路径，output.pdf 是生成的 PDF 文件的名称。

如果您还是无法生成 PDF 文件，请尝试添加 -lines 标志。例如：

pprof --pdf -lines /path/to/binary /path/to/profile > output.pdf
这将为 PDF 文件生成源代码行号。

如果以上两种方法都无法解决问题，请尝试升级 gperftools 工具或者更换其他 CPU 分析工具。

最后，如果以上方法仍然无法解决问题，您可以查看 gperftools 的官方文档或联系他们的技术支持团队以获取更进一步的技术支持。
```





### 其他

*****

CPU迁移和上下文切换：发生上下文切换不一定会发生CPU迁移，而发生CPU迁移时肯定会发生上下文切换。发生上下文切换有可能只是把上下文从当前CPU中换出，下一次调度器还是将进程安排在这个CPU上执行。

系统的性能上不去？


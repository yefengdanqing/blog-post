---
title: babylon遗漏学习
toc: true
date: 2023-05-04 22:26:59
tags:
- 
categories:
- 
typora-root-url: ..\img
---

#### 概念

c++用户日志落盘要经过那三次拷贝

在 C++ 程序中，日志落盘通常要经历几次数据拷贝，具体过程可能因框架或实现方式不同而略有差异。按照常见的日志记录和系统调用流程，假设你是通过 `writev` 系统调用来将日志数据落盘，典型的拷贝过程如下：

1. **用户空间缓冲区 1 (日志格式化)**:
   - 日志系统通常会有一个缓冲区用于存放格式化后的日志消息。在这个阶段，日志内容（比如时间戳、消息级别、实际日志内容）会先从日志消息构造或拼接函数里生成，并存入一个用户空间的缓冲区。这个过程会有一次数据的拷贝（例如从临时的日志消息对象或输入参数拷贝到日志缓冲区）。
2. **用户空间缓冲区 2 (内部缓冲区)**:
   - 在日志系统中，可能存在多个缓冲区。例如，你提到的 `streambuf`、`render_msgbuf` 等，都是可能的中间缓冲区。数据会被拷贝到某个最终要写入磁盘的缓冲区。这个阶段属于内部缓冲区之间的数据拷贝，第二次拷贝发生在从一个内部缓冲区到另一个缓冲区的过程中。
3. **内核空间缓冲区 (系统调用)**:
   - 当程序调用 `writev` 或其他类似的系统调用时，日志数据会从用户空间缓冲区拷贝到内核空间缓冲区。这个步骤是日志从用户空间进入内核空间，以便操作系统将数据写入文件或磁盘设备。这个是第三次拷贝。

### 总结：

- **第一次拷贝**：日志数据从日志消息对象或拼接过程中拷贝到第一个用户空间缓冲区（如 `streambuf`）。
- **第二次拷贝**：日志系统内部缓冲区之间的数据拷贝（如从 `render_msgbuf` 到 `current_buffer`）。
- **第三次拷贝**：通过 `writev` 系统调用，数据从用户空间缓冲区拷贝到内核空间缓冲区，准备写入磁盘。

每次拷贝都有其必要性，例如格式化日志、组织数据块、以及跨越用户和内核空间的边界。在优化日志系统时，减少不必要的拷贝操作有助于提高性能。

<!-- more -->

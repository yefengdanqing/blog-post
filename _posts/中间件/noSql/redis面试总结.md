---
title: redis面试总结
toc: true
date: 2022-02-22 15:26:49
tags:
- redis
categories:
- 组件
typora-root-url: ..\img
---

###### 缓存击穿

定义：当一个热点key之前在redis缓存中存在，后来过期了，然后这个热点key直接去mysql或者底层数据存储介质中查找的时候，由于底层的存储介质并不能抗住最外层的处理，可能导致底层的介质奔溃或者不可用。

方案：在缓存失效后，通过互斥锁或者队列来控制读数据写缓存的线程数量，比如某个key只允许一个线程查询数据和写缓存，其他线程等待。这种方式会阻塞其他的线程，此时系统的吞吐量会下降；热点可以不设置过期时间

###### 缓存穿透

定义：当一个key在缓存中不存在，并且在mysql中也不存在时，导致请求持续访问这两个介质；如果有恶意攻击，导致mysql扛不住挂了，

方案：特定次数请求后设置永久不过期,如果是随机值则存在问题；用布隆过滤器，于是我们可以在缓存之前再加一个布隆过滤器，将数据库中的所有key都存储在布隆过滤器中，在查询Redis前先去布隆过滤器查询 key 是否存在，如果不存在就直接返回，不让其访问数据库，从而避免了对底层存储系统的查询压力。

<!-- more -->

布隆过滤器：

选择一个位数组，这个位数组尽可能大，然后有k个哈希函数；

对每一个元素，根据这个k个哈希函数算出索引值，然后将bit位置1；

当有元素来的时候，查这个字节位数组，如果都是1说明存在，只要有0说明不存在。

###### 缓存雪崩

定义：表示在某个时间点，大量的key 过期，导致外层请求直接打在底层存储介质上导致底层介质奔溃或者不可用；

方案：设置不同的过期时间，比如在特定时间的基础上加一个随机时间；分两级缓存，设置不同的缓存时间；热点数据永远不过期；高可用；

###### 缓存预热

定义：提前将热点数据保存在redis缓存中

方案：通过脚本的方式提前加载

缓存降级：

定义：

方案：

###### redis 分布式锁

前置:setnx [ SET if Not eXists]（如果不存在会插入成功，返回1；如果存在，插入不成功，返回0）;setex 存在会覆盖；在set 命令中可以通过EX/PX来设置过期时间，通过NX和XX来判断是否存在来设置，NX是不存在设置（not exist),XX存在设置

加锁的时候可以把value设置为一个唯一的id[防止乱释放]

SETEX，用法`SETEX key seconds value`

解锁就是通过lua封装get和del

缺陷：

- 客户端长时间阻塞导致锁失效
- redis服务器始终漂移问题
- 单点实例安全问题【为了解决Redis单点问题，redis的作者提出了**RedLock**算法】
- **锁过期释放，业务没执行完**的问题
  - 开启一个定时守护线程，每隔一段时间检查锁是否还存在，存在则对锁的过期时间延长，防止锁过期提前释放。
  - 多机实现的分布式锁Redlock+Redisson，搞多个Redis master部署，以保证它们不会同时宕掉。并且这些master节点是完全相互独立的，相互之间不存在数据同步。同时，需要确保在这多个master实例上，是与在Redis单实例，使用相同方法来获取和释放锁。
  - ![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0df0a36c7ccd439291a8a869ff4ddad3~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp)

- 过程

  1.获取当前时间，以毫秒为单位。

  2.按顺序向5个master节点请求加锁。客户端设置网络连接和响应超时时间，并且超时时间要小于锁的失效时间。（假设锁自动失效时间为10秒，则超时时间一般在5-50毫秒之间,我们就假设超时时间是50ms吧）。如果超时，跳过该master节点，尽快去尝试下一个master节点。

  3.客户端使用当前时间减去开始获取锁时间（即步骤1记录的时间），得到获取锁使用的时间。当且仅当超过一半（N/2+1，这里是5/2+1=3个节点）的Redis master节点都获得锁，并且使用的时间小于锁失效时间时，锁才算获取成功。（如上图，10s> 30ms+40ms+50ms+4m0s+50ms）

  如果取到了锁，key的真正有效时间就变啦，需要减去获取锁所使用的时间。

  如果获取锁失败（没有在至少N/2+1个master实例取到锁，有或者获取锁时间已经超过了有效时间），客户端要在所有的master节点上解锁（即便有些master节点根本就没有加锁成功，也需要解锁，以防止有些漏网之鱼）。

redis结点宕机了怎么办？某个哨兵节点宕机了怎么办？哨兵的数量对新主节点的选取有什么影响吗？【一般可以3个】

###### 疑问

哨兵模式

redis主结点挂了的话，会自动选出一个主（有一套自己的处理流程，稍微有些复杂），并将变化通知给客户端（旧的主结点，会被自动拉起么？）

redis从结点挂了的话，会被自动拉起么？【通知管理员或者应用程序】

某个哨兵结点宕机了，会被自动拉起么？

哨兵的数量对新主节点的选取有什么影响吗？哨兵的leader选举是用的raft协议，需要超过半数人同意才能选举出来leader，所以至少3个结点（最多容忍1个哨兵宕机）

集群模式

主结点挂了之后，集群会检测到并自动故障恢复（也有一套自己的处理流程，稍微有些复杂）自动选出一个新主（旧主会被自动拉起么？）

从结点挂了之后，会被自动拉起么？
